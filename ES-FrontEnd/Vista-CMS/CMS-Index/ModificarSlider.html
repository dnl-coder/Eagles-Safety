<!--===========================================================
    CONTENIDO GENERAL DE LA VISTA
=============================================================-->

<!--VISTA PREVIA-->
<section class="contenedor-principal my-1 mx-auto">

<!--TITULO-->
<h3 class="titulo mb-3">ACTUALIZAR SLIDERS DE LA PAGINA PRINCIPAL</h3>

<!--SLIDERS-->
<div id="CarouselInicio" class="carousel slide" data-ride="carousel">

<!--SLIDES-->
<div id="contenidoVistaPrevia" class="carousel-inner" role="listbox">
</div>

<!--CONTROLES-->
<a class="carousel-control-prev" href="#CarouselInicio" role="button" data-slide="prev">
    <span aria-hidden="true"><i class="fa fa-chevron-left fa-2x"></i></span>
    <span class="sr-only">Previous</span>
</a>
<a class="carousel-control-next" href="#CarouselInicio" role="button" data-slide="next">
    <span aria-hidden="true"><i class="fa fa-chevron-right fa-2x"></i></span>
    <span class="sr-only">Next</span>
</a>

</div>                    
</section>

<!--OPCIONES-->
<div class="contenedor-principal alert alert-dark p-1 mx-auto row" role="alert" style="margin-top: 16px; margin-bottom: 9px;">
  <div class="font-weight-bold pt-2 pl-4 h5-responsive">Slider usados <span id="cantSlider">4</span> de 8</div>
  <button class="btn py-2 ml-auto enfasis1" data-toggle="modal" data-target="#agregarSlider">Agregar</button>
  <button class="btn py-2 enfasis2" onclick="cargarDatos()">Actualizar</button>
</div>

<!--SLIDERS-->
<div class="contenedor-principal mx-auto">
    <div id="contenidoModificar" class="row mx-auto">
    </div>
</div>

<!-- MODAL AÑADIR SLIDER -->
<div class="modal fade" id="agregarSlider" tabindex="-1" role="dialog" aria-labelledby="agregarSlider"
  aria-hidden="true">

  <div class="modal-dialog modal-dialog-centered" role="document">

    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Añadir nuevo Slider</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <form action="" id="form" class="text-center">
            <div class="md-form">
              <input type="text" id="titulo" class="form-control">
              <label for="titulo">Titulo</label>
            </div>
                
            <div class="md-form">
              <input type="text" id="descripcion" class="form-control">
              <label for="descripcion">Descripcion</label>
            </div>
               
            <img id="previewFoto" class="formulario mx-auto my-2" style="width: 460px; height: 250px;">
            <input id="foto" class="my-2" name="archivo" type="file" accept="image/*"><input type="text" hidden id="estado">
 
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>
        <button id="guardar" type="button" class="btn btn-primary" onClick="validarFormulario()">Guardar</button>
      </div>
    </div>
  </div>
</div>

<!-- TOAST -->
 <div role="alert" aria-live="assertive" aria-atomic="true" class="toast py-1 px-3 succesfull z-depth-3" data-delay="4000" data-animation="true">
    <div class="toast-body">Mensaje</div>
 </div>

<!--===========================================================
    SCRIPTS DE LA VISTA
=============================================================-->

<script>
var mostrar=false;
//--INICIALIZAR FUNCIONES--
cargarDatos();
mostrarToast();
    
//--LLAMAR A FUNCION MOSTRAR IMAGEN AL CARGAR IMAGEN--  
var inputFile = document.getElementById('foto');
inputFile.addEventListener('change', vGenerales.mostrarImagen, false);  

//--CARGAR DATOS DE LA TABLA SLIDER--  
function cargarDatos(){
    
    var slider="", slider2="";
    
    $.ajax({
        url: 'ES-BackEnd/Controlador/Controlador-CMS/Controlador_MostrarSliders.php',
        type: 'GET',
        dataType: 'json',
        error: function(error){
            if(error.status == 401){
                console.log("No se pudo establecer conexion con el servidor")
            }
            else{
                console.log("Error no identificado.")
            }
        },
        success: function(datos){
            if(datos.response == 0){
                $("#contenidoVistaPrevia").html("");
                $("#contenidoModificar").html("");
            }
            else{
                for(var i=0; i<datos.length; i++){
                    if(i==0){
                        slider+="<div class='carousel-item active' style='background:url("+datos[i].SLDRIMAGEN+");'> \
                            <div class='descripcionSlider row container-fluid m-0 wow fadeIn justify-content-center' data-wow-delay='0.4s'>\
                                <p class='col-12 text-center h1-responsive'>"+datos[i].SLDRDESCRIPCION+"</p>\
                                <a class='btn btn-sm disabled green wow rubberBand white-text' data-wow-delay='0.4s' href='#two'>VER MÁS</a>\
                            </div>\
                        </div>\
                    </div>"
                    }else{
                        slider+="<div class='carousel-item' style='background:url("+datos[i].SLDRIMAGEN+");'> \
                            <div class='descripcionSlider row container-fluid m-0 wow fadeIn justify-content-center' data-wow-delay='0.4s'>\
                                <p class='col-12 text-center h1-responsive'>"+datos[i].SLDRDESCRIPCION+"</p>\
                                <a class='btn btn-sm green wow rubberBand white-text' data-wow-delay='0.4s' href='#two'>VER MÁS</a>\
                            </div>\
                        </div>\
                    </div>"
                    }
                    
                    slider2+="<div class='col-3 my-2'>\
            <img src='"+datos[i].SLDRIMAGEN+"' width='280' height='180'>\
            <div>\
                <button class='py-1 btn text-red font-weight-bold' onclick='eliminarSlider("+datos[i].SLDRCODIGO+")' style='background-color: rgba(244, 67, 54, 1); position: absolute; bottom: 0;'>X</button>\
            </div>\
        </div>"
                    
                }
                $("#contenidoVistaPrevia").html(slider);
                $("#contenidoModificar").html(slider2);
                $("#cantSlider").html(datos.length);
                
            }
        }
    });
    
}
    
//--ELIMINAR SLIDER--      
function eliminarSlider(cod){
    
    var $datos={
        '_codigo': cod
    }
    
    $.ajax({
        url: 'ES-BackEnd/Controlador/Controlador-CMS/Controlador_EliminarSlider.php',
        type: 'POST',
        data: $datos,
        dataType: 'json',
        error: function(error){
            if(error.status == 401){
                console.log("No se pudo establecer conexion con el servidor")
            }
            else{
                console.log("Error no identificado.")
            }
        },
        success: function(datos){
            if(datos.response == 0){
                console.log('ERROR: '+datos.message)
            }
            else{
                mostrar=true;
                mostrarToast('exito','Imagen eliminada correctamente');
                cargarDatos();
            }
        }
    });
    
}
    
//--VALIDAR DATOS INGRESADOS EN EL FORMULARIO--  
function validarFormulario(){
  
    var R1 = $("#titulo").val();
    var R2 = $("#descripcion").val();
    
    if(R1 == null || R1.length == 0 || /^\s+$/.test(R1)){
        alert('ERROR: El campo no debe ir vacío o lleno solamente espacios en blanco');
        $("#titulo").focus();
    }
    else if(R2 == null || R2.length == 0 || /^\s+$/.test(R2)){
        alert('ERROR: El campo no debe ir vacío o lleno solamente espacios en blanco');
        $("#descripcion").focus();
    }else{
        guardarImagenSlider();
        if ($("#estado").val() == "IMAGEN GUARDADA CORRECTAMENTE"){
            agregarSlider()
        }else{
            alert($("#estado").val());
        }
    }
        
} 

//--GUARDAR IMAGEN DEL SLIDER--  
function guardarImagenSlider(){
  
  var nuevoFormulario = new FormData();   
  $("#form").find(':input').each(function() {
    var elemento= this;
    //Si recibe tipo archivo 'file'
    if(elemento.type === 'file'){
       if(elemento.value !== ''){
          for(var i=0; i< $('#'+elemento.id).prop("files").length; i++){
              nuevoFormulario.append(elemento.name, $('#'+elemento.id).prop("files")[i]);
           }
       }              
     }
  });

  $.ajax({
      url: "ES-BackEnd/Controlador/Controlador-CMS/Controlador_GuardarImagenSlider.php",
      type: "POST",
      data: nuevoFormulario,
      contentType: false,
      processData: false,
      async:false,
      success: function(datos){
        if(datos.response==0){
              $("#estado").val("ERROR AL GUARDAR LA IMAGEN: "+datos.message)
          }else{
              $("#estado").val("IMAGEN GUARDADA CORRECTAMENTE")
          }
      }
  });
}    
    
//--AÑADIR SLIDER--
function agregarSlider(){
    var rutaFoto,nombreFoto;
  
    if(document.getElementById('foto').files[0].name == undefined){
      if(document.getElementById('previewFoto').src==""){
        rutaFoto="";
      }else{
        nombreFoto=document.getElementById('previewFoto').src.split("/Slider/");
        rutaFoto="ES-FrontEnd/Elementos/Imagenes/Slider/"+nombreFoto[1];
      }
    }else{
      rutaFoto="ES-FrontEnd/Elementos/Imagenes/Slider/"+document.getElementById('foto').files[0].name
    }
    
    var $datos={
        '_titulo': $("#titulo").val(),
        '_descripcion': $("#descripcion").val(),
        '_rutaFoto': rutaFoto
    }
    
    $.ajax({
        url: 'ES-BackEnd/Controlador/Controlador-CMS/Controlador_AgregarSlider.php',
        type: 'POST',
        data: $datos,
        dataType: 'json',
        error: function(error){
            if(error.status == 401){
                console.log("No se pudo establecer conexion con el servidor")
            }
            else{
                console.log("Error no identificado.")
            }
        },
        success: function(datos){
            if(datos.response == 0){
                console.log('ERROR: '+datos.message)
            }
            else{
                document.getElementById("guardar").disabled=false;
                $('#agregarSlider').modal('hide');
                $("#titulo").val("");
                $("#descripcion").val("");
                $("#foto").val("");
                document.getElementById('previewFoto').src="";
                cargarDatos();
            }
        }
    });
    
}
	
//--MOSTRAR TOAST CON MENSAJE--
function mostrarToast(tipo,msj){
    if(mostrar==true){
				switch(tipo){
					case 'exito':
						$(".toast").removeClass("succesfull");
						$(".toast").removeClass("error");
						
						$(".toast").addClass("succesfull");
						break;
					case 'error':
						$(".toast").removeClass("succesfull");
						$(".toast").removeClass("error");
						
						$(".toast").addClass("error");
						break;
				}
				
        $('.toast-body').html('');
        $('.toast-body').html(msj);
			
        $('.toast').toast('show');
        $('.toast').addClass('visualizar');
    }
    mostrar=false;
}

</script>